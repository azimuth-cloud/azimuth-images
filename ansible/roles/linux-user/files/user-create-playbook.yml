---

- hosts: localhost
  gather_facts: true
  vars:
    openstack_metadata: "{{ (lookup('url', 'http://169.254.169.254/openstack/latest/meta_data.json') | from_json).get('meta', {}) }}"
    openstack_userdata: "{{ (lookup('url', 'http://169.254.169.254/openstack/latest/user_data', split_lines=false) | from_yaml) }}"
  vars_files:
    - /etc/ansible-init/vars/user.yml
  tasks:
    - name: Get Azimuth user metadata
      ansible.builtin.set_fact:
        azimuth_username: "azimuth"
        azimuth_uid: "{{ openstack_metadata['azimuth_workstation_uid'] | default('1006') }}"
        azimuth_gid: "{{ openstack_metadata['azimuth_workstation_gid'] | default('1006') }}"
        azimuth_is_sudo: "{{ openstack_metadata['azimuth_workstation_is_sudo'] | default(true) }}"
        azimuth_ssh_keys: "{{ openstack_userdata.azimuth_users[0].ssh_authorized_keys | default([]) }}"

    - name: Setup Azimuth home directory
      ansible.builtin.file:
        path: "{{ user_mountpoint }}/{{ azimuth_username }}-home"
        state: directory
      become: true

    - name: Setup bind mount for Azimuth home directory
      ansible.posix.mount:
        src: "{{ user_mountpoint }}/{{ azimuth_username }}-home"
        path: "/home/{{ azimuth_username }}"
        opts: bind
        fstype: none
        state: mounted
      become: true

    - name: Ensure the Azimuth user is created
      ansible.builtin.user:
        name: "{{ azimuth_username }}"
        uid: "{{ azimuth_uid }}"
        shell: "/bin/bash"
      become: true

    - name: Ensure the Azimuth group has the correct GID
      ansible.builtin.group:
        name: "{{ azimuth_username }}"
        gid: "{{ azimuth_gid }}"
      become: true

    - name: Ensure Azimuth home directory has the correct permissions
      ansible.builtin.file:
        path: "{{ user_mountpoint }}"
        state: directory
        owner: "{{ azimuth_username }}"
        group: "{{ azimuth_username }}"
        mode: '750'
        recurse: true
      become: true

    - name: Setup public keys for the Azimuth user
      ansible.posix.authorized_key:
        user: "{{ azimuth_username }}"
        state: present
        key: "{{ item }}"
      with_items: "{{ azimuth_ssh_keys }}"

    - name: Add the Azimuth user to sudoers
      ansible.builtin.user:
        name: "{{ azimuth_username }}"
        groups: sudo
      when: azimuth_is_sudo | bool

    - name: Make sudo without password for users
      ansible.builtin.copy:
        dest: /etc/sudoers.d/80-ansible-sudo-user
        content: "{{ azimuth_username }} ALL=(ALL) NOPASSWD:ALL"
        mode: 0440
      when: azimuth_is_sudo | bool
