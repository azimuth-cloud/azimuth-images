---

- hosts: localhost
  gather_facts: true
  become: true
  vars_files:
    - /etc/ansible-init/vars/guacamole.yml
  tasks:
    - name: Generate SSH keypair for Guacamole
      # Guacamole requires that the key is PEM-formatted
      #Â See https://issues.apache.org/jira/browse/GUACAMOLE-745
      # This means that we cannot use community.crypto.openssh_keypair :-(
      command: >-
        ssh-keygen
          -m PEM
          -t rsa
          -b 3072
          -q
          -N ""
          -f /etc/guacamole/id_rsa
          -C "Generated-for-Guacamole"

    - name: Set SSH keypair facts
      set_fact:
        guacamole_ssh_public_key: "{{ lookup('file', '/etc/guacamole/id_rsa.pub') }}"
        guacamole_ssh_private_key: "{{ lookup('file', '/etc/guacamole/id_rsa') }}"
    
    - name: Remove SSH keypair files
      file:
        path: "/etc/guacamole/{{ item }}"
        state: absent
      loop:
        - id_rsa
        - id_rsa.pub

    - name: Add public key to Guacamole user
      ansible.posix.authorized_key:
        user: "{{ guacamole_user }}"
        state: present
        key: "{{ guacamole_ssh_public_key }}"

    - block:
        - name: Generate password for Guacamole
          set_fact:
            guacamole_password: "{{ lookup('community.general.random_string', length = 16, override_special = special_chars) }}"
          vars:
            # Even though this string is within a CDATA tag, there's very small chance of
            # generating ]]>, which will still break XML. Therefore remove ">" from special
            # characters.
            special_chars: '!"#$%&()*+,-./:;<=?@[\]^_`{|}~'
        
        - name: Configure default user
          ansible.builtin.user:
            name: "{{ guacamole_user }}"
            state: present
            password: "{{ guacamole_password | password_hash('sha512') }}"
            append: true
            groups: ssl-cert
          become: true
      when: desktop_enabled

    - name: Write Guacamole user mapping file
      copy:
        content: |
          <user-mapping>
              <authorize username="portal" password="portal">
                  <connection name="shell">
                      <protocol>ssh</protocol>
                      <param name="hostname">{{ ansible_default_ipv4.address }}</param>
                      <param name="port">22</param>
                      <param name="username">{{ guacamole_user }}</param>
                      <param name="private-key">{{ guacamole_ssh_private_key }}</param>
                      <param name="enable-sftp">true</param>
                  </connection>
          {% if desktop_enabled %}
                  <connection name="desktop">
                      <protocol>rdp</protocol>
                      <param name="hostname">{{ ansible_default_ipv4.address }}</param>
                      <param name="port">3389</param>
                      <param name="username">{{ guacamole_user }}</param>
                      <param name="password"><![CDATA[{{ guacamole_password }}]]></param>
                  </connection>
          {% endif %}
              </authorize>
          </user-mapping>
        dest: /etc/guacamole/user-mapping.xml

    - name: Start and enable Guacamole services
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - guacamole
        - guacamole-server
        - guacamole-client
        - guacamole-mitm
